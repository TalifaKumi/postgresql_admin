 

БД перестала быть доступной из-за в автоматического остановки субд после превышения максимального возраста транзакции, для дальнейшего разрешения ошибок административно во избежание полной остановки бд.

Фиксировались массовые ошибки при обращении к таблицам.

Для разрешения ошибок бд была перезапущена в монопольный режим и выполнена операция VACUUM FREEZE  для таблиц c наиболее старыми транзакциями.

Рекомендация для мониторинга выполнять запрос, что исключит неожиданности подобного характера

SELECT datname
    , age(datfrozenxid)
    , current_setting('autovacuum_freeze_max_age') 
FROM pg_database 
ORDER BY 2 DESC;

Параметры отвечающие за возраст транзакции, текущие значения.
autovacuum_freeze_max_age - 200000000

vacuum_freeze_table_age - 150000000

vacuum_freeze_min_age - 50000000

 

в зависимости от активности бд и количества транзакций можно пойти по пути увеличения autovacuum_freeze_max_age или уменьшения vacuum_freeze_table_age.

Предлагаем 
увеличить autovacuum_freeze_max_age - 300000000  

и проследить как будет справляться автовакуум.
возможно потребуется уменьшать vacuum_freeze_table_age.

параметр autovacuum_freeze_max_age позволительно выставлять индивидуально для таблиц.

Кроме того в текущей конфигурации настроен весьма агрессивный автовауум
autovacuum_vacuum_scale_factor - 0.002 (0.2% от размера таблицы)

autovacuum_analyze_scale_factor  - 0.001  (0.1% от размера таблицы)

Фиксируются массовые операции автовакуума временных таблиц , тем самым занимает ресурсы и воркеры.

предлагаем выставить 

autovacuum_vacuum_scale_factor - 0.02 (2% от размера таблицы)

autovacuum_analyze_scale_factor  - 0.01  (1% от размера таблицы)

Параметры можно переопределить индивидуально для таблиц.

В дальнейшем выше указанные параметры могут скорректированы.

 ====================================================================================
 ---остановка бд

service postgresql stop

--- запуск в монопольном режиме для бд 

export PGDATA=/database/pgsql/data

postgres --single ave_skd

-- выполнение для всех таблиц vacuum freeze

psql> vacuum (freeze, analyze, verbose) _inforg14634;

...


postgres --single GilevRu_Latch

psql> vacuum (freeze, analyze, verbose) _inforg42;

....


---запуск бд

service postgresql start

 
